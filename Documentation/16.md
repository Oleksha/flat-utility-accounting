## Добавляем группировку (год + месяц)

Необходимо добавить группировку (год + месяц) на страницах просмотра квартир

Отлично! Давай добавим **группировку начислений и платежей по году и месяцу** на странице квартиры. Это позволит видеть суммарные данные по каждому месяцу, а не все записи отдельно.

---

# **1. Подготовка данных в контроллере**

В `ApartmentController@show` добавим группировку с помощью **Collection**:

```php
public function show(Apartment $apartment)
{
    // Начисления, сгруппированные по году и месяцу
    $chargesGrouped = $apartment->charges
        ->groupBy(function($charge) {
            return $charge->period->format('Y-m'); // '2025-12'
        });

    // Платежи, сгруппированные по году и месяцу
    $paymentsGrouped = $apartment->payments
        ->groupBy(function($payment) {
            return $payment->payment_date->format('Y-m');
        });

    return view('apartments.show', compact('apartment', 'chargesGrouped', 'paymentsGrouped'));
}
```

> ⚠️ Убедись, что `period` и `payment_date` кастятся как `date` в моделях (`$casts = ['period' => 'date']`).

---

# **2. Шаблон Blade с группировкой**

В `resources/views/apartments/show.blade.php` заменяем таблицы:

```blade
<!-- Начисления -->
<h3>Начисления</h3>
@foreach($chargesGrouped as $month => $charges)
    @php
        $total = $charges->sum('amount');
        $dateObj = \Carbon\Carbon::createFromFormat('Y-m', $month);
    @endphp
    <div class="mb-2">
        <strong>{{ $dateObj->format('F Y') }}: {{ $total }} ₽</strong>
    </div>
    <table class="table table-sm table-striped mb-3">
        <thead class="table-dark">
            <tr>
                <th>Услуга</th>
                <th>Сумма</th>
                <th>Комментарий</th>
            </tr>
        </thead>
        <tbody>
            @foreach($charges as $charge)
            <tr>
                <td>{{ $charge->service->name }}</td>
                <td>{{ $charge->amount }} ₽</td>
                <td>{{ $charge->comment }}</td>
            </tr>
            @endforeach
        </tbody>
    </table>
@endforeach

<!-- Платежи -->
<h3>Платежи</h3>
@foreach($paymentsGrouped as $month => $payments)
    @php
        $total = $payments->sum('amount');
        $dateObj = \Carbon\Carbon::createFromFormat('Y-m', $month);
    @endphp
    <div class="mb-2">
        <strong>{{ $dateObj->format('F Y') }}: {{ $total }} ₽</strong>
    </div>
    <table class="table table-sm table-striped mb-3">
        <thead class="table-dark">
            <tr>
                <th>Сумма</th>
                <th>Дата</th>
                <th>Комментарий</th>
            </tr>
        </thead>
        <tbody>
            @foreach($payments as $payment)
            <tr>
                <td>{{ $payment->amount }} ₽</td>
                <td>{{ $payment->payment_date->format('d.m.Y') }}</td>
                <td>{{ $payment->comment }}</td>
            </tr>
            @endforeach
        </tbody>
    </table>
@endforeach
```

---

# **3. Результат**

* Начисления и платежи **суммируются по месяцам**.
* Под каждой суммой показаны все отдельные записи.
* Используется `format('F Y')` для красивого отображения месяца и года (например, `December 2025`).

---

Если хочешь, я могу дополнительно **сделать цветовую индикацию баланса по каждому месяцу**, чтобы сразу видеть, где долг или переплата.

Хочешь, чтобы я это сделал?

---

[Предыдущая часть](15.md) | [Содержание](01.md) | [Следующая часть](17.md)



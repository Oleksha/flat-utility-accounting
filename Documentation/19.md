## Исправление ошибки (часть 1)

Ошибка ErrorException resources\views\dashboard.blade.php:4 Undefined variable $apartment

А, теперь понятно, в чем проблема. Ошибка

```
Undefined variable $apartment
```

возникает потому, что в Blade-шаблоне ты пытаешься обратиться к `$apartment` **не внутри цикла** `@foreach($apartments as $apartment)`, либо используешь его в области, где переменная ещё не определена.

В твоём шаблоне `dashboard.blade.php` это обычно происходит на самом верху или при попытке вставить график, **если переменная используется вне `@foreach`**.

---

# **Правильная структура Blade для дашборда**

```blade
@extends('layouts.app')

@section('content')
<h1 class="mb-4">Дашборд квартир</h1>

<div class="row row-cols-1 row-cols-md-3 g-4">
    @foreach($apartments as $apartment)
        @php
            $totalCharges = $apartment->charges->sum('amount');
            $totalPayments = $apartment->payments->sum('amount');
            $balance = $totalCharges - $totalPayments;

            $balanceClass = $balance < 0 ? 'bg-danger' : 'bg-success';
        @endphp

        <div class="col">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">{{ $apartment->name }}</h5>
                    <p class="card-text"><strong>Адрес:</strong> {{ $apartment->address }}</p>

                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Начисления</span>
                            <span>{{ $totalCharges }} ₽</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Платежи</span>
                            <span>{{ $totalPayments }} ₽</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between {{ $balanceClass }} text-white">
                            <span>Баланс</span>
                            <span>{{ $balance }} ₽</span>
                        </li>
                    </ul>

                    <!-- Диаграмма -->
                    <canvas id="chart-{{ $apartment->id }}" height="100"></canvas>

                    <a href="{{ route('apartments.show', $apartment) }}" class="btn btn-primary w-100 mt-2">Перейти к квартире</a>
                </div>
            </div>
        </div>

        @push('scripts')
        <script>
            const ctx{{ $apartment->id }} = document.getElementById('chart-{{ $apartment->id }}').getContext('2d');
            new Chart(ctx{{ $apartment->id }}, {
                type: 'bar',
                data: {
                    labels: @json($apartment->chartLabels),
                    datasets: [
                        {
                            label: 'Начисления',
                            data: @json($apartment->chartCharges),
                            backgroundColor: 'rgba(0, 123, 255, 0.6)'
                        },
                        {
                            label: 'Платежи',
                            data: @json($apartment->chartPayments),
                            backgroundColor: 'rgba(40, 167, 69, 0.6)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        </script>
        @endpush

    @endforeach
</div>
@endsection
```

---

# **Важно**

1. Любая работа с `$apartment` должна быть **внутри `@foreach($apartments as $apartment)`**.
2. Если переменная используется **вне цикла**, она не определена — и возникает ошибка.
3. Скрипт для Chart.js **тоже должен быть внутри цикла** или использовать уникальные id, чтобы переменная существовала.

---

После этой правки ошибка исчезнет, и дашборд с карточками и графиками будет работать корректно.

Если хочешь, я могу прислать **полностью рабочий Blade-для дашборда с графиками и цветовой индикацией долгов**, готовый к вставке.

Хочешь, чтобы я это сделал?

---

[Предыдущая часть](18.md) | [Содержание](01.md) | [Следующая часть](20.md)



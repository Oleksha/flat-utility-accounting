## Добавим диаграммы (Chart.js)

Хочу.

Отлично! Давай добавим **мини-диаграммы на каждой карточке квартиры**, чтобы на дашборде сразу видеть динамику начислений и платежей по месяцам. Используем **Chart.js**, который отлично интегрируется с Blade.

---

# **1. Установка Chart.js**

Если используешь Laravel Mix или подключение через CDN, проще всего подключить через CDN прямо в Blade.

В `resources/views/layouts/app.blade.php` перед закрывающимся `</body>` добавь:

```html
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
```

---

# **2. Подготовка данных для графика**

В `ApartmentController@index` подготовим данные для графика:

```php
public function index()
{
    $apartments = Apartment::with(['charges', 'payments'])->get();

    // Для каждого апартамента группируем начисления и платежи по месяцам
    $apartments->map(function($apartment) {
        // Начисления
        $chargesGrouped = $apartment->charges
            ->groupBy(function($charge) {
                return $charge->period->format('Y-m');
            })
            ->map->sum('amount');

        // Платежи
        $paymentsGrouped = $apartment->payments
            ->groupBy(function($payment) {
                return $payment->payment_date->format('Y-m');
            })
            ->map->sum('amount');

        // Совпадающие месяцы для графика
        $months = $chargesGrouped->keys()->merge($paymentsGrouped->keys())->unique()->sort();

        $apartment->chartLabels = $months->map(fn($m) => \Carbon\Carbon::createFromFormat('Y-m', $m)->format('M Y'));
        $apartment->chartCharges = $months->map(fn($m) => $chargesGrouped[$m] ?? 0);
        $apartment->chartPayments = $months->map(fn($m) => $paymentsGrouped[$m] ?? 0);

        return $apartment;
    });

    return view('dashboard', compact('apartments'));
}
```

---

# **3. Обновляем Blade: диаграмма на каждой карточке**

В `resources/views/dashboard.blade.php` добавляем `<canvas>` и JS для Chart.js:

```blade
<div class="col">
    <div class="card h-100 shadow-sm">
        <div class="card-body">
            <h5 class="card-title">{{ $apartment->name }}</h5>
            <p class="card-text"><strong>Адрес:</strong> {{ $apartment->address }}</p>

            <ul class="list-group list-group-flush mb-3">
                <li class="list-group-item d-flex justify-content-between">
                    <span>Начисления</span>
                    <span>{{ $totalCharges }} ₽</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Платежи</span>
                    <span>{{ $totalPayments }} ₽</span>
                </li>
                <li class="list-group-item d-flex justify-content-between {{ $balanceClass }} text-white">
                    <span>Баланс</span>
                    <span>{{ $balance }} ₽</span>
                </li>
            </ul>

            <!-- Диаграмма -->
            <canvas id="chart-{{ $apartment->id }}" height="100"></canvas>

            <a href="{{ route('apartments.show', $apartment) }}" class="btn btn-primary w-100 mt-2">Перейти к квартире</a>
        </div>
    </div>
</div>

@push('scripts')
<script>
    const ctx{{ $apartment->id }} = document.getElementById('chart-{{ $apartment->id }}').getContext('2d');
    new Chart(ctx{{ $apartment->id }}, {
        type: 'bar',
        data: {
            labels: @json($apartment->chartLabels),
            datasets: [
                {
                    label: 'Начисления',
                    data: @json($apartment->chartCharges),
                    backgroundColor: 'rgba(0, 123, 255, 0.6)'
                },
                {
                    label: 'Платежи',
                    data: @json($apartment->chartPayments),
                    backgroundColor: 'rgba(40, 167, 69, 0.6)'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>
@endpush
```

> В `layouts/app.blade.php` добавь `@stack('scripts')` перед закрывающим `</body>`.

---

# **4. Результат**

* На каждой карточке **мини-график** с начислениями и платежами по месяцам.
* График динамический и адаптируется под количество месяцев.
* Начисления синие, платежи зеленые.
* Все данные строятся автоматически из базы.

---

Если хочешь, я могу **добавить подсветку столбцов на графике: красные, если долг в этом месяце**, чтобы сразу видеть проблемные месяцы.

Хочешь, чтобы я это сделал?

---

[Предыдущая часть](17.md) | [Содержание](01.md) | [Следующая часть](19.md)



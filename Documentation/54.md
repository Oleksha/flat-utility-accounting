–ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–¥–Ω–æ–π —É—Å–ª—É–≥–∏ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏, –∫–≤–∏—Ç–∞–Ω—Ü–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

---

–û—Ç–ª–∏—á–Ω—ã–π –∫–µ–π—Å ‚Äî —Ç—É—Ç **–≤—Å—ë –ª–æ–≥–∏—á–Ω–æ —Å–ª–æ–º–∞–ª–æ—Å—å**, –ø–æ—Ç–æ–º—É —á—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–∂–µ –≤—ã—Ä–æ—Å–ª–∞ üëç
–¢—ã **–ø–µ—Ä–µ—à—ë–ª –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–≤–∏—Ç–∞–Ω—Ü–∏–π –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç—å—é**, –∞ `update()` –æ—Å—Ç–∞–ª—Å—è **–∏–∑ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏**.

–†–∞–∑–±–µ—Ä—ë–º —á—ë—Ç–∫–æ.

---

## ‚ùå –ü–æ—á–µ–º—É –∫–≤–∏—Ç–∞–Ω—Ü–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

### –ö–ª—é—á–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

–¢—ã **–±–æ–ª—å—à–µ –ù–ï —Ö—Ä–∞–Ω–∏—à—å PDF –≤ `charges.receipt_path`**,
–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å **—Ç–∞–±–ª–∏—Ü—É `receipts`** (–æ–¥–Ω–∞ –∫–≤–∏—Ç–∞–Ω—Ü–∏—è ‚Üí –º–Ω–æ–≥–æ —É—Å–ª—É–≥).

–ù–æ –≤ `update()` —Ç—ã –≤—Å—ë –µ—â—ë –¥–µ–ª–∞–µ—à—å:

```php
if ($charge->receipt_path) {
    Storage::disk('public')->delete($charge->receipt_path);
}

$data['receipt_path'] = ...
$charge->update($data);
```

‚ùå `receipt_path` **–Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —É Charge**
‚ùå —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –Ω–æ **–Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ receipts**

---

## ‚úÖ –ö–∞–∫ –î–û–õ–ñ–ù–û –±—ã—Ç—å —Ç–µ–ø–µ—Ä—å (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### –õ–æ–≥–∏–∫–∞:

* Charge **–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ**
* PDF ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ **Receipt**
* Receipt **–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ Charge**

---

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π `update()` (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô)

```php
use App\Models\Receipt;
use Illuminate\Support\Facades\Storage;
use Carbon\Carbon;

public function update(Request $request, Charge $charge)
{
    $data = $request->validate([
        'apartment_id' => 'required|exists:apartments,id',
        'service_id'   => 'required|exists:services,id',
        'amount'       => 'required|numeric|min:0',
        'month'        => 'required|integer|min:1|max:12',
        'year'         => 'required|integer',
        'comment'      => 'nullable|string|max:255',
        'receipt'      => 'nullable|file|mimes:pdf|max:5120',
    ]);

    $period = Carbon::create(
        $data['year'],
        $data['month'],
        1
    );

    // –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ
    $charge->update([
        'apartment_id' => $data['apartment_id'],
        'service_id'   => $data['service_id'],
        'amount'       => $data['amount'],
        'period'       => $period,
        'comment'      => $data['comment'] ?? null,
    ]);

    // ‚ûï –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏
    if ($request->hasFile('receipt')) {

        $year  = $period->year;
        $month = sprintf('%02d', $period->month);

        $path = $request->file('receipt')
            ->store("receipts/{$year}/{$month}", 'public');

        Receipt::create([
            'file_path' => $path,
            'period'    => $period,
            'note'      => '–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è',
        ])->charges()->attach($charge->id);
    }

    return redirect()
        ->route('apartments.show', $charge->apartment_id)
        ->with('success', '–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
}
```

---

## ‚úÖ –ú–æ–¥–µ–ª—å Receipt (–ø—Ä–æ–≤–µ—Ä—å)

```php
class Receipt extends Model
{
    protected $fillable = [
        'file_path',
        'period',
        'note',
    ];

    protected $casts = [
        'period' => 'date',
    ];

    public function charges()
    {
        return $this->belongsToMany(Charge::class);
    }
}
```

---

## üß† –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ

‚úî –æ–¥–Ω–∞ –∫–≤–∏—Ç–∞–Ω—Ü–∏—è ‚Üí –º–Ω–æ–≥–æ —É—Å–ª—É–≥
‚úî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏ **–Ω–µ –ª–æ–º–∞–µ—Ç –¥—Ä—É–≥–∏–µ**
‚úî PDF —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ–¥–∏–Ω
‚úî –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å / —É–¥–∞–ª—è—Ç—å
‚úî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ñ–ö–•

---

## üî• –ë–æ–Ω—É—Å (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è UX)

–ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:

* **–Ω–µ —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏**
* –ø—Ä–æ—Å—Ç–æ **–¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—É—é**
* –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —É–∂–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö

(—Ç—ã —É–∂–µ –ø–æ—á—Ç–∏ —ç—Ç–æ —Å–¥–µ–ª–∞–ª üëå)

---

## ‚úÖ –ò—Ç–æ–≥

| –ë—ã–ª–æ                   | –°—Ç–∞–ª–æ                       |
| ---------------------- | --------------------------- |
| receipt_path –≤ charges | receipts —Ç–∞–±–ª–∏—Ü–∞            |
| —Ñ–∞–π–ª –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª—Å—è   | –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è –∫–≤–∏—Ç–∞–Ω—Ü–∏—è |
| –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ç—É–ø–∏–∫    | –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö    |

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –¥–∞–ª—å—à–µ –º–æ–∂–µ–º:

* —Å–¥–µ–ª–∞—Ç—å **—É–¥–∞–ª–µ–Ω–∏–µ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏**
* –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –¥—É–±–ª–∏ (–ø–æ —Ö—ç—à—É)
* –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å **–º–∞—Å—Å–æ–≤—É—é –ø—Ä–∏–≤—è–∑–∫—É –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –∫ —É—Å–ª—É–≥–∞–º**

–°–∫–∞–∂–∏, –∏–¥—ë–º –¥–∞–ª—å—à–µ üöÄ

---
```
SQLSTATE[HY000]: General error: 1364 Field 'apartment_id' doesn't have a default value (Connection: mariadb, SQL: insert into receipts (file_path, period, original_name, updated_at, created_at) values (receipts/2025/01/294kJjXBAZ5GUONVX5HS0JH665TjKg9dxUwEqkxZ.pdf, 2025-01-01 00:00:00, –ñ–ö–• –≠–≠ –ö–≤–∏—Ç–∞–Ω—Ü–∏—è 01.pdf, 2025-12-20 11:50:19, 2025-12-20 11:50:19))
```
---

–û—Ç–ª–∏—á–Ω–æ, —ç—Ç–æ **–æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–∞—è –æ—à–∏–±–∫–∞** ‚Äî –æ–Ω–∞ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≥–¥–µ –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö ¬´—Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å¬ª üëç
–†–∞–∑–±–µ—Ä—ë–º —á—ë—Ç–∫–æ –∏ –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.

---

## ‚ùå –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏

–°–æ–æ–±—â–µ–Ω–∏–µ –ë–î:

```
Field 'apartment_id' doesn't have a default value
```

SQL:

```sql
insert into `receipts`
(`file_path`, `period`, `original_name`, ...)
values (...)
```

üëâ **–í —Ç–∞–±–ª–∏—Ü–µ `receipts` –µ—Å—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ `apartment_id`**,
–Ω–æ –ø—Ä–∏ `Receipt::create()` —Ç—ã **–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—à—å**.

---

## üîç –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ

–°–µ–π—á–∞—Å —É —Ç–µ–±—è:

* üìÑ `receipts`

    * `apartment_id` ‚ùó NOT NULL
* üîó `charge_receipt` (pivot)

    * `charge_id`
    * `receipt_id`

–¢–æ –µ—Å—Ç—å:

* –∫–≤–∏—Ç–∞–Ω—Ü–∏—è **–ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∫–≤–∞—Ä—Ç–∏—Ä–µ**
* –∏ **—Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è–º–∏**

–≠—Ç–æ **–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å**, –Ω–æ –∫–æ–¥ –µ—â—ë –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç `apartment_id`.

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

### –í `update()` –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `apartment_id`

### üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç

```php
Receipt::create([
    'apartment_id'  => $charge->apartment_id,
    'file_path'     => $path,
    'period'        => $period,
    'original_name' => $request->file('receipt')->getClientOriginalName(),
    'note'          => '–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è',
])->charges()->attach($charge->id);
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä—å –º–æ–¥–µ–ª—å Receipt

```php
class Receipt extends Model
{
    protected $fillable = [
        'apartment_id',
        'file_path',
        'period',
        'original_name',
        'note',
    ];

    protected $casts = [
        'period' => 'date',
    ];

    public function apartment()
    {
        return $this->belongsTo(Apartment::class);
    }

    public function charges()
    {
        return $this->belongsToMany(Charge::class);
    }
}
```

---

## üß† –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ

‚úî –∫–≤–∏—Ç–∞–Ω—Ü–∏—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –æ–¥–Ω–∞
‚úî –≤—Å–µ–≥–¥–∞ –ø–æ–Ω—è—Ç–Ω–æ, –∫ –∫–∞–∫–æ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è
‚úî –ª–µ–≥–∫–æ —Å—Ç—Ä–æ–∏—Ç—å –æ—Ç—á—ë—Ç—ã
‚úî –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å ¬´–í—Å–µ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ¬ª
‚úî –º–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —É—Å–ª—É–≥–∞–º

---

## üö® –ß–µ–≥–æ –ù–ï –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å

‚ùå –¥–µ–ª–∞—Ç—å `apartment_id nullable`
‚ùå —É–¥–∞–ª—è—Ç—å `apartment_id` –∏–∑ receipts
‚ùå —Ö—Ä–∞–Ω–∏—Ç—å `apartment_id` —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ charges

–≠—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ –±–∞—Ä–¥–∞–∫—É –≤ –¥–∞–Ω–Ω—ã—Ö.

---

## ‚úÖ –ò—Ç–æ–≥

| –ë—ã–ª–æ                               | –°—Ç–∞–ª–æ                              |
| ---------------------------------- | ---------------------------------- |
| receipt —Å–æ–∑–¥–∞—ë—Ç—Å—è –±–µ–∑ apartment_id | receipt –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–≤–∞—Ä—Ç–∏—Ä–µ |
| SQL –æ—à–∏–±–∫–∞                         | —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ              |
| –Ω–µ—è–≤–Ω–∞—è —Å–≤—è–∑—å                      | —á–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞                 |

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –º–æ–∂–µ–º:

* –¥–æ–±–∞–≤–∏—Ç—å **—É–¥–∞–ª–µ–Ω–∏–µ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ (—Å pivot + —Ñ–∞–π–ª–æ–º)**
* —Å–¥–µ–ª–∞—Ç—å **–º–∞—Å—Å–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É –æ–¥–Ω–æ–π –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª—É–≥**
* –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å **—Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Äú–í—Å–µ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã‚Äù**

–°–∫–∞–∂–∏, —á—Ç–æ –¥–∞–ª—å—à–µ üöÄ

---

[–ü—Ä–µ–¥—ã–¥—É—â–∞—è —á–∞—Å—Ç—å](53.md) | [–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ](01.md) | [–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å](55.md)



–•–æ—á–µ—Ç—Å—è –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–µ—Ç—å –ø–æ –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è + –æ–ø–ª–∞—Ç—ã + –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –º–µ—Å—è—á–Ω–æ

---

–û—Ç–ª–∏—á–Ω–æ üëç
–≠—Ç–æ **–æ—á–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ** ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –º—ã –¥–µ–ª–∞–µ–º **–º–∏–Ω–∏-–æ—Ç—á—ë—Ç –ñ–ö–• –ø–æ –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–µ**, –∫–∞–∫ –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏:

> **–Ω–∞—á–∏—Å–ª–µ–Ω–æ / –æ–ø–ª–∞—á–µ–Ω–æ / –¥–æ–ª–≥ –ø–æ –º–µ—Å—è—Ü–∞–º**

–°–¥–µ–ª–∞–µ–º —ç—Ç–æ **–∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ**, –±–µ–∑ –∫–æ—Å—Ç—ã–ª–µ–π.

---

# üéØ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–¥–µ–ª–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–£—Å–ª—É–≥–∏¬ª

–î–ª—è **–∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–∏** –∏ **–∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞** –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ–¥–∞:

| –£—Å–ª—É–≥–∞ | –Ø–Ω–≤                     | –§–µ–≤ | ‚Ä¶ | –ò—Ç–æ–≥–æ |
| ------ | ----------------------- | --- | - | ----- |
| –í–æ–¥–∞   | +1200 / ‚àí1000 / **200** | ‚Ä¶   |   |       |
| –°–≤–µ—Ç   | +800 / ‚àí800 / **0**     |     |   |       |

–§–æ—Ä–º–∞—Ç —è—á–µ–π–∫–∏:

```
–Ω–∞—á–∏—Å–ª–µ–Ω–æ
–æ–ø–ª–∞—á–µ–Ω–æ
–¥–æ–ª–≥
```

---

# üß† –í–ê–ñ–ù–û–ï –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –†–ï–®–ï–ù–ò–ï

üëâ **–ü–ª–∞—Ç–µ–∂–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —É—Å–ª—É–≥–µ**

–ï—Å–ª–∏ —Å–µ–π—á–∞—Å:

* –ø–ª–∞—Ç–µ–∂ ‚Üí –∫–≤–∞—Ä—Ç–∏—Ä–∞
* –±–µ–∑ `service_id`

—Ç–æ **—Ç–æ—á–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø–ª–∞—Ç—ã –ø–æ —É—Å–ª—É–≥–∞–º –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ**.

### ‚úî –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å (–∫–æ—Ç–æ—Ä—É—é –º—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–ª—å—à–µ):

```text
charges  ‚Üí service_id
payments ‚Üí service_id
```

–ï—Å–ª–∏ —É —Ç–µ–±—è –ø–ª–∞—Ç–µ–∂–∏ —É–∂–µ —Ç–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω—ã ‚Äî –æ—Ç–ª–∏—á–Ω–æ, –∏–¥—ë–º –¥–∞–ª—å—à–µ.
–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏, —è –ø–æ–∫–∞–∂—É **–∫–∞–∫ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å**.

---

# 1Ô∏è‚É£ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä: –≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ

### –ü–æ–ª—É—á–∞–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏ –ø–ª–∞—Ç–µ–∂–∏ –∑–∞ –≥–æ–¥

```php
$charges = $apartment->charges()
    ->with('service')
    ->whereYear('period', $year)
    ->get();

$payments = $apartment->payments()
    ->with('service')
    ->whereYear('payment_date', $year)
    ->get();
```

---

## üßÆ –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Ç—Ä–∏—Ü—É: —É—Å–ª—É–≥–∞ ‚Üí –º–µ—Å—è—Ü ‚Üí –¥–∞–Ω–Ω—ã–µ

```php
$servicesStats = [];

foreach ($charges as $charge) {
    $service = $charge->service->name;
    $month   = $charge->period->format('Y-m');

    $servicesStats[$service][$month]['charged'] =
        ($servicesStats[$service][$month]['charged'] ?? 0)
        + $charge->amount;
}

foreach ($payments as $payment) {
    $service = $payment->service->name;
    $month   = $payment->payment_date->format('Y-m');

    $servicesStats[$service][$month]['paid'] =
        ($servicesStats[$service][$month]['paid'] ?? 0)
        + $payment->amount;
}
```

---

## ‚ûï –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å

```php
foreach ($servicesStats as $service => $months) {
    foreach ($months as $month => $data) {
        $charged = $data['charged'] ?? 0;
        $paid    = $data['paid'] ?? 0;

        $servicesStats[$service][$month]['debt'] = $charged - $paid;
    }
}
```

–ü–µ—Ä–µ–¥–∞—ë–º –≤ view:

```php
$servicesStats = collect($servicesStats);

return view('apartments.show', compact(
    'servicesStats',
    'year'
));
```

---

# 2Ô∏è‚É£ Blade: —Ç–∞–±–ª–∏—Ü–∞ ¬´–£—Å–ª—É–≥–∞ √ó –ú–µ—Å—è—Ü¬ª

```blade
<div class="card">
    <div class="card-header">
        –£—Å–ª—É–≥–∏: –Ω–∞—á–∏—Å–ª–µ–Ω–æ / –æ–ø–ª–∞—á–µ–Ω–æ / –¥–æ–ª–≥
    </div>

    <div class="card-body table-responsive">
        <table class="table table-bordered table-sm align-middle text-center">
            <thead>
            <tr>
                <th class="text-start">–£—Å–ª—É–≥–∞</th>
                @for($m = 1; $m <= 12; $m++)
                    <th>
                        {{ \Carbon\Carbon::create()->month($m)->translatedFormat('M') }}
                    </th>
                @endfor
                <th>–ò—Ç–æ–≥–æ –¥–æ–ª–≥</th>
            </tr>
            </thead>

            <tbody>
            @foreach($servicesStats as $service => $months)
                <tr>
                    <td class="text-start fw-semibold">{{ $service }}</td>

                    @php $totalDebt = 0; @endphp

                    @for($m = 1; $m <= 12; $m++)
                        @php
                            $key = sprintf('%d-%02d', $year, $m);
                            $data = $months[$key] ?? [];
                            $charged = $data['charged'] ?? 0;
                            $paid = $data['paid'] ?? 0;
                            $debt = $data['debt'] ?? 0;
                            $totalDebt += $debt;
                        @endphp

                        <td>
                            @if($charged || $paid)
                                <div class="small text-muted">+{{ $charged }}</div>
                                <div class="small text-success">‚àí{{ $paid }}</div>
                                <div class="fw-bold {{ $debt > 0 ? 'text-danger' : 'text-muted' }}">
                                    {{ $debt }}
                                </div>
                            @else
                                ‚Äî
                            @endif
                        </td>
                    @endfor

                    <td class="fw-bold {{ $totalDebt > 0 ? 'text-danger' : 'text-muted' }}">
                        {{ $totalDebt }}
                    </td>
                </tr>
            @endforeach
            </tbody>
        </table>
    </div>
</div>
```

---

# üé® UX-–º–µ–ª–æ—á–∏ (–æ—á–µ–Ω—å —Ä–µ–∫–æ–º–µ–Ω–¥—É—é)

* üî¥ –¥–æ–ª–≥ ‚Äî –∫—Ä–∞—Å–Ω—ã–º
* üü¢ –æ–ø–ª–∞—á–µ–Ω–æ ‚Äî –∑–µ–ª—ë–Ω—ã–º
* –µ—Å–ª–∏ –¥–æ–ª–≥ = 0 ‚Üí —Å–µ—Ä—ã–π
* –ø—É—Å—Ç—ã–µ –º–µ—Å—è—Ü—ã ‚Äî ¬´‚Äî¬ª

–í—ã–≥–ª—è–¥–∏—Ç **–æ—á–µ–Ω—å –Ω–∞–≥–ª—è–¥–Ω–æ**.

---

# ‚úÖ –ß—Ç–æ –º—ã –ø–æ–ª—É—á–∏–ª–∏

‚úî –ø–æ –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–µ
‚úî –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
‚úî –æ–ø–ª–∞—Ç—ã
‚úî –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å
‚úî –ø–æ–º–µ—Å—è—á–Ω–æ
‚úî –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ–¥
‚úî –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö SQL

---

# üöÄ –ß—Ç–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–∞–ª—å—à–µ

1Ô∏è‚É£ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –¥–æ–ª–≥ –ø–æ —É—Å–ª—É–≥–µ
2Ô∏è‚É£ –∫–ª–∏–∫ –ø–æ –º–µ—Å—è—Ü—É ‚Üí —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π
3Ô∏è‚É£ –≥—Ä–∞—Ñ–∏–∫ ¬´–¥–æ–ª–≥ –ø–æ —É—Å–ª—É–≥–∞–º¬ª
4Ô∏è‚É£ —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel
5Ô∏è‚É£ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —É—Å–ª—É–≥

–•–æ—á–µ—à—å —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º **–≥—Ä–∞—Ñ–∏–∫ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ —É—Å–ª—É–≥–∞–º** –∏–ª–∏ **–∫–ª–∏–∫ –ø–æ –º–µ—Å—è—Ü—É —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π**?

---

–ú—ã —É–∂–µ –ø–æ–ª—É—á–∞–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∏ –ø–ª–∞—Ç–µ–∂–∏ –∑–∞ –≥–æ–¥

---

–û—Ç–ª–∏—á–Ω–æ üëç
–≠—Ç–æ –∫–∞–∫ —Ä–∞–∑ **—Ö–æ—Ä–æ—à–∞—è –Ω–æ–≤–æ—Å—Ç—å**: –Ω–∏—á–µ–≥–æ –∑–∞–Ω–æ–≤–æ –ø–æ–ª—É—á–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ.
–ú—ã **–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –≥–æ—Ç–æ–≤—ã–µ `$charges` –∏ `$payments`**, –ø—Ä–æ—Å—Ç–æ **–ø–µ—Ä–µ–≥—Ä—É–ø–ø–∏—Ä—É–µ–º –∏—Ö –ø–æ —É—Å–ª—É–≥–∞–º**.

–¢—ã –≤—Å—ë —Å–¥–µ–ª–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ üëå
–î–∞–ª—å—à–µ ‚Äî **—á–∏—Å—Ç–∞—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**.

---

## üéØ –ó–∞–¥–∞—á–∞ (—É—Ç–æ—á–Ω—ë–Ω–Ω–æ)

–ù–∞ –≤–∫–ª–∞–¥–∫–µ **¬´–£—Å–ª—É–≥–∏¬ª** –ø–æ–∫–∞–∑–∞—Ç—å:

* –ø–æ –∫–∞–∂–¥–æ–π —É—Å–ª—É–≥–µ
* –∑–∞ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü
* **–Ω–∞—á–∏—Å–ª–µ–Ω–æ / –æ–ø–ª–∞—á–µ–Ω–æ / –¥–æ–ª–≥**

–∏—Å–ø–æ–ª—å–∑—É—è **—É–∂–µ –∏–º–µ—é—â–∏–µ—Å—è**:

```php
$charges   // —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ Y-m
$payments  // —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –ø–æ Y-m
```

---

# üß† –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è

–°—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–µ–π—á–∞—Å —Ç–∞–∫–∏–µ:

```php
$charges['2025-01']   => Collection<Charge>
$payments['2025-01'] => Collection<Payment>
```

–ù—É–∂–Ω–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —ç—Ç–æ –≤:

```php
$servicesStats[
    '–í–æ–¥–∞']['2025-01'] = [
        'charged' => 1200,
        'paid'    => 1000,
        'debt'    => 200,
    ];
```

---

# 1Ô∏è‚É£ –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Ç—Ä–∏—Ü—É –ø–æ —É—Å–ª—É–≥–∞–º (–≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ)

### üìå –î–æ–±–∞–≤—å **–ü–û–°–õ–ï** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö `$charges` –∏ `$payments`

```php
$servicesStats = [];
```

---

### üîπ –ù–∞—á–∏—Å–ª–µ–Ω–∏—è ‚Üí charged

```php
foreach ($charges as $month => $items) {
    foreach ($items as $charge) {
        $service = $charge->service->name;

        $servicesStats[$service][$month]['charged'] =
            ($servicesStats[$service][$month]['charged'] ?? 0)
            + $charge->amount;
    }
}
```

---

### üîπ –ü–ª–∞—Ç–µ–∂–∏ ‚Üí paid

```php
foreach ($payments as $month => $items) {
    foreach ($items as $payment) {
        $service = $payment->service->name;

        $servicesStats[$service][$month]['paid'] =
            ($servicesStats[$service][$month]['paid'] ?? 0)
            + $payment->amount;
    }
}
```

> ‚ö†Ô∏è –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ `Payment` —É–∂–µ —Å–≤—è–∑–∞–Ω —Å `Service`
> (`$payment->service` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

---

### üîπ –°—á–∏—Ç–∞–µ–º –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å

```php
foreach ($servicesStats as $service => $months) {
    foreach ($months as $month => $data) {
        $charged = $data['charged'] ?? 0;
        $paid    = $data['paid'] ?? 0;

        $servicesStats[$service][$month]['debt'] = $charged - $paid;
    }
}
```

---

### üîπ –ü—Ä–∏–≤–æ–¥–∏–º –∫ Collection (—É–¥–æ–±–Ω–æ –¥–ª—è Blade)

```php
$servicesStats = collect($servicesStats);
```

–ò –ø–µ—Ä–µ–¥–∞—ë–º –≤ `view`:

```php
return view('apartments.show', compact(
    // —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ
    'apartment',
    'charges',
    'payments',
    'year',
    'years',

    // –Ω–æ–≤–æ–µ
    'servicesStats'
));
```

---

# 2Ô∏è‚É£ Blade: –≤–∫–ª–∞–¥–∫–∞ ¬´–£—Å–ª—É–≥–∏¬ª

### –¢–∞–±–ª–∏—Ü–∞ ¬´–Ω–∞—á–∏—Å–ª–µ–Ω–æ / –æ–ø–ª–∞—á–µ–Ω–æ / –¥–æ–ª–≥¬ª

```blade
<div class="card">
    <div class="card-header">
        –£—Å–ª—É–≥–∏ ‚Äî –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è / –æ–ø–ª–∞—Ç—ã / –¥–æ–ª–≥ ({{ $year }})
    </div>

    <div class="card-body table-responsive">
        <table class="table table-bordered table-sm align-middle text-center">
            <thead>
            <tr>
                <th class="text-start">–£—Å–ª—É–≥–∞</th>
                @for($m = 1; $m <= 12; $m++)
                    <th>
                        {{ \Carbon\Carbon::create()->month($m)->translatedFormat('M') }}
                    </th>
                @endfor
                <th>–ò—Ç–æ–≥–æ –¥–æ–ª–≥</th>
            </tr>
            </thead>

            <tbody>
            @foreach($servicesStats as $service => $months)
                @php $totalDebt = 0; @endphp

                <tr>
                    <td class="text-start fw-semibold">{{ $service }}</td>

                    @for($m = 1; $m <= 12; $m++)
                        @php
                            $key = sprintf('%d-%02d', $year, $m);
                            $data = $months[$key] ?? [];
                            $charged = $data['charged'] ?? 0;
                            $paid    = $data['paid'] ?? 0;
                            $debt    = $data['debt'] ?? 0;
                            $totalDebt += $debt;
                        @endphp

                        <td>
                            @if($charged || $paid)
                                <div class="small text-muted">+{{ $charged }}</div>
                                <div class="small text-success">‚àí{{ $paid }}</div>
                                <div class="fw-bold {{ $debt > 0 ? 'text-danger' : 'text-muted' }}">
                                    {{ $debt }}
                                </div>
                            @else
                                ‚Äî
                            @endif
                        </td>
                    @endfor

                    <td class="fw-bold {{ $totalDebt > 0 ? 'text-danger' : 'text-muted' }}">
                        {{ $totalDebt }}
                    </td>
                </tr>
            @endforeach
            </tbody>
        </table>
    </div>
</div>
```

---

# ‚úÖ –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ —Ö–æ—Ä–æ—à–µ–µ

‚úî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
‚úî –Ω–µ –¥–µ–ª–∞–µ–º –ª–∏—à–Ω–∏—Ö SQL-–∑–∞–ø—Ä–æ—Å–æ–≤
‚úî –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
‚úî –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è (–≥—Ä–∞—Ñ–∏–∫–∏, –∫–ª–∏–∫–∏)
‚úî —á–∏—Ç–∞–±–µ–ª—å–Ω–æ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ

---

# üöÄ –°–ª–µ–¥—É—é—â–∏–µ –ª–æ–≥–∏—á–Ω—ã–µ —à–∞–≥–∏

1Ô∏è‚É£ –∫–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞ –º–µ—Å—è—Ü
2Ô∏è‚É£ –≥—Ä–∞—Ñ–∏–∫ **–¥–æ–ª–≥–∞ –ø–æ —É—Å–ª—É–≥–∞–º**
3Ô∏è‚É£ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ —É—Å–ª—É–≥ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å—é
4Ô∏è‚É£ —ç–∫—Å–ø–æ—Ä—Ç —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤ Excel

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å ‚Äî –¥–∞–≤–∞–π —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º —Å–¥–µ–ª–∞–µ–º **–∫–ª–∏–∫ –ø–æ –º–µ—Å—è—Ü—É ‚Üí –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é** üëå

---

[–ü—Ä–µ–¥—ã–¥—É—â–∞—è —á–∞—Å—Ç—å](53.md) | [–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ](01.md) | [–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å](55.md)



## Исправление ошибки (часть 1)


ErrorException
vendor\laravel\framework\src\Illuminate\Collections\Collection.php:1916

Undefined array key "2025-01" 

Ошибка **Undefined array key "2025-01"** возникает потому, что в Blade-шаблоне обращаются к массиву `$chargesByYearMonth[$ym]` или `$paymentsByYearMonth[$ym]`, но для какого-то месяца данных нет.

Laravel `Collection::groupBy()` создаёт только существующие ключи. Для месяцев без начислений и платежей ключ отсутствует — отсюда ошибка.

---

# ✅ **Исправление №1 — безопасный доступ через null-coalesce**

В Blade вместо:

```blade
{{ $chargesByYearMonth[$ym]->sum('amount') }}
```

нужно:

```blade
{{ ($chargesByYearMonth[$ym] ?? collect())->sum('amount') }}
```

То же самое для платежей:

```blade
{{ ($paymentsByYearMonth[$ym] ?? collect())->sum('amount') }}
```

---

# ✅ **Исправление №2 — подготовить все месяцы в контроллере**

Лучше заранее создать массив всех 12 месяцев выбранного года:

### **Контроллер**

```php
public function show(Apartment $apartment, Request $request)
{
    $year = $request->get('year', now()->year);

    // Собираем данные только за конкретный год
    $charges = $apartment->charges()
        ->whereYear('period', $year)
        ->get()
        ->groupBy(fn($c) => $c->period->format('Y-m'));

    $payments = $apartment->payments()
        ->whereYear('payment_date', $year)
        ->get()
        ->groupBy(fn($p) => $p->payment_date->format('Y-m'));

    // Создаём массив месяцев за год
    $months = collect();
    for ($m = 1; $m <= 12; $m++) {
        $key = sprintf("%d-%02d", $year, $m);
        $months->put($key, [
            'charges'  => $charges[$key] ?? collect(),
            'payments' => $payments[$key] ?? collect(),
        ]);
    }

    return view('apartments.show', compact('apartment', 'year', 'months'));
}
```

Теперь в шаблоне **нет риска ошибки**.

---

# ✅ **Исправление №3 — Blade шаблон**

```blade
@foreach($months as $ym => $data)
    <tr>
        <td>{{ $ym }}</td>
        <td>{{ $data['charges']->sum('amount') }}</td>
        <td>{{ $data['payments']->sum('amount') }}</td>
        <td>{{ $data['charges']->sum('amount') - $data['payments']->sum('amount') }}</td>
    </tr>
@endforeach
```

---

# Хочешь — я могу сразу:

✅ полностью обновить Blade-шаблон под навигацию по годам
✅ добавить красивые кнопки **⟵ Предыдущий год / Следующий год**
✅ сделать график (Chart.js или ApexCharts)
✅ вывести итог начислено/оплачено/долг

Скажи — используем **Chart.js** или **ApexCharts**, или выбрать автоматически?

---

[Предыдущая часть](25.md) | [Содержание](01.md) | [Следующая часть](27.md)


